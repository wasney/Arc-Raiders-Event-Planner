<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Guild Availability</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #0f1012;
            --card-bg: #1a1c20;
            --modal-bg: #22252b;
            --accent-color: #ff4c29;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --border-color: #333;
            --success-color: #2ecc71;
            --input-bg: #25282e;
        }

        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
        }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }

        /* --- NAVIGATION --- */
        header {
            background-color: rgba(15, 16, 18, 0.95);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-color);
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }
        nav ul { display: flex; gap: 20px; }
        nav a { font-size: 0.9rem; font-weight: 600; color: var(--text-dim); transition: color 0.3s; }
        nav a:hover { color: var(--accent-color); }
        .nav-external { color: #4cd1ff !important; }

        /* --- LAYOUT --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .hero {
            text-align: center;
            padding: 4rem 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800; }
        .hero p { font-size: 1.1rem; color: var(--text-dim); margin-bottom: 2rem; }

        /* --- BUTTONS --- */
        .btn-discord {
            background-color: #5865F2;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        .btn-discord:hover { background-color: #4752C4; }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        .btn-secondary:hover { background-color: rgba(255, 76, 41, 0.1); }

        .btn-logout {
            background-color: var(--card-bg);
            color: var(--text-dim);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 2rem;
        }

        /* --- CARDS & FORMS --- */
        .card {
            max-width: 600px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            margin-top: 2rem;
        }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dim); }
        select, input {
            width: 100%; padding: 12px; background-color: var(--input-bg);
            border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-main); font-family: inherit;
        }
        
        .user-info { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .avatar { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent-color); }
        .status-badge {
            background: rgba(46, 204, 113, 0.2); color: var(--success-color);
            padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        .profile-details {
            margin-top: 1rem; text-align: left; width: 100%;
            background: var(--bg-color); padding: 1rem; border-radius: 4px;
        }
        .detail-row {
            display: flex; justify-content: space-between; margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;
        }

        /* --- MODAL (For Schedule Editing) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--modal-bg); width: 95%; max-width: 500px;
            padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-btn { background: none; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; }
        
        /* Schedule Grid */
        .day-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
            background: var(--bg-color); padding: 10px; border-radius: 4px;
        }
        .day-check { width: 20px; height: 20px; }
        .day-label { width: 50px; font-weight: bold; }
        .time-inputs { display: flex; gap: 5px; flex-grow: 1; align-items: center; }
        .time-inputs input { padding: 5px; font-size: 0.9rem; }
        
        .disabled-row { opacity: 0.5; pointer-events: none; }

        /* --- UTILS --- */
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 10px; }
            nav ul { gap: 15px; }
            .hero h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">RAIDER // SIGNAL</div>
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="https://first-wave-bp-share.netlify.app/" target="_blank" class="nav-external">Blueprint Tool ‚Üó</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section id="login-section" class="hero">
            <h1>Coordinate. Survive. Extract.</h1>
            <p>Connect with your guild to manage raid availability.</p>
            <button id="loginBtn" class="btn-discord">Login with Discord</button>
        </section>

        <section id="onboarding-section" class="card hidden">
            <h2>Operator Registration</h2>
            <p style="margin-bottom: 20px; color: var(--text-dim);">Finalize your profile.</p>
            <form id="profileForm">
                <div class="form-group">
                    <label for="playstyle">Preferred Playstyle</label>
                    <select id="playstyle" required>
                        <option value="PvP">PvP</option>
                        <option value="PvE">PvE</option>
                        <option value="Hybrid">Hybrid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="region">Region</label>
                    <select id="region" required>
                        <option value="NA">North America</option>
                        <option value="EU">Europe</option>
                        <option value="ASIA">Asia</option>
                        <option value="OC">Oceania</option>
                        <option value="SA">South America</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Initialize Profile</button>
            </form>
        </section>
        
        <section id="dashboard-section" class="card hidden">
            <div class="user-info">
                <img id="userAvatar" src="" alt="Avatar" class="avatar">
                <h2 id="userName">Welcome, Raider</h2>
                <span class="status-badge">‚óè SIGNAL ESTABLISHED</span>
            </div>

            <div class="profile-details">
                <div class="detail-row">
                    <span>Playstyle:</span><strong id="displayPlaystyle">-</strong>
                </div>
                <div class="detail-row">
                    <span>Region:</span><strong id="displayRegion">-</strong>
                </div>
                <div class="detail-row" style="border: none;">
                    <span>Routine:</span><strong id="displayRoutineStatus">Not Set</strong>
                </div>
            </div>

            <button id="editScheduleBtn" class="btn-secondary">Edit Weekly Schedule</button>
            <button id="logoutBtn" class="btn-logout">Disconnect Signal (Logout)</button>
        </section>
    </main>

    <div id="scheduleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Weekly Availability</h3>
                <button id="closeModalBtn" class="close-btn">&times;</button>
            </div>
            <p style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 1rem;">
                Set your "Standard" weekly hours. Uncheck days you are offline.
            </p>
            <form id="scheduleForm">
                <div id="daysContainer"></div>
                
                <button type="submit" class="btn-primary">Save Routine</button>
            </form>
        </div>
    </div>

    <footer>
        &copy; 2026 Arc Raiders Guild Tool.
    </footer>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://olmaoftlbrookqwxvlvx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sbWFvZnRsYnJvb2txd3h2bHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTI0MzQsImV4cCI6MjA4NTgyODQzNH0.D7iwaB1rQbQwNvQAlFkYsxW7G12zIQAHSlksFr3KxZo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const loginSection = document.getElementById('login-section');
        const onboardingSection = document.getElementById('onboarding-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const scheduleModal = document.getElementById('scheduleModal');
        const daysContainer = document.getElementById('daysContainer');
        
        // Buttons
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileForm = document.getElementById('profileForm');
        const editScheduleBtn = document.getElementById('editScheduleBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const scheduleForm = document.getElementById('scheduleForm');

        // Display Elements
        const userNameDisplay = document.getElementById('userName');
        const userAvatarDisplay = document.getElementById('userAvatar');
        const displayPlaystyle = document.getElementById('displayPlaystyle');
        const displayRegion = document.getElementById('displayRegion');
        const displayRoutineStatus = document.getElementById('displayRoutineStatus');

        // Days Config
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

        // --- AUTH & INIT ---
        async function signInWithDiscord() {
            const currentURL = window.location.href; 
            await supabaseClient.auth.signInWithOAuth({
                provider: 'discord',
                options: { redirectTo: currentURL }
            });
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session) checkProfile(session);
            else {
                loginSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                onboardingSection.classList.add('hidden');
            }
        });

        // --- PROFILE LOGIC (FIXED) ---
        async function checkProfile(session) {
            const user = session.user;
            
            // Try to find existing profile
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            // If error is not "Row Missing" (PGRST116), it's a real problem (network, etc)
            if (error && error.code !== 'PGRST116') {
                console.error("Critical Profile Error:", error);
                alert("Database Connection Error: " + error.message);
                return;
            }

            if (data) {
                // SUCCESS: Profile found
                showDashboard(session, data);
                if(data.availability_json) {
                    populateScheduleModal(data.availability_json);
                    displayRoutineStatus.textContent = "Active";
                    displayRoutineStatus.style.color = "var(--success-color)";
                } else {
                    populateScheduleModal(null);
                }
            } else {
                // FAILURE: No Profile -> Show Onboarding
                showOnboarding(session);
            }
        }

        async function createProfile(e) {
            e.preventDefault();
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const playstyle = document.getElementById('playstyle').value;
            const region = document.getElementById('region').value;
            const discordName = user.user_metadata.full_name || 
                                user.user_metadata.custom_claims?.global_name || 
                                "Raider";
            const avatarUrl = user.user_metadata.avatar_url;

            // FIX: Use UPSERT (Update if exists, Insert if new)
            // Also select() to get the data back immediately
            const { data, error } = await supabaseClient
                .from('profiles')
                .upsert({
                    id: user.id, 
                    discord_name: discordName, 
                    avatar_url: avatarUrl,
                    play_style: playstyle, 
                    region: region
                })
                .select()
                .single();

            if (error) {
                alert("Failed to save profile: " + error.message);
            } else {
                // FIX: Do NOT reload. Just switch to dashboard immediately.
                showDashboard(null, data); 
            }
        }

        // --- SCHEDULE LOGIC ---
        function populateScheduleModal(savedData) {
            daysContainer.innerHTML = ''; 
            
            DAYS.forEach(day => {
                const dayKey = day.toLowerCase();
                const existing = savedData ? savedData[dayKey] : null;
                const isActive = existing ? existing.active : false;
                const start = existing ? existing.start : "18:00";
                const end = existing ? existing.end : "22:00";

                const row = document.createElement('div');
                row.className = `day-row ${isActive ? '' : 'disabled-row'}`;
                row.innerHTML = `
                    <input type="checkbox" class="day-check" data-day="${dayKey}" ${isActive ? 'checked' : ''}>
                    <span class="day-label">${day.substring(0,3)}</span>
                    <div class="time-inputs">
                        <input type="time" class="time-start" value="${start}" ${isActive ? '' : 'disabled'}>
                        <span>to</span>
                        <input type="time" class="time-end" value="${end}" ${isActive ? '' : 'disabled'}>
                    </div>
                `;
                
                const checkbox = row.querySelector('.day-check');
                const inputs = row.querySelectorAll('input[type="time"]');
                checkbox.addEventListener('change', (e) => {
                    if(e.target.checked) {
                        row.classList.remove('disabled-row');
                        inputs.forEach(i => i.disabled = false);
                    } else {
                        row.classList.add('disabled-row');
                        inputs.forEach(i => i.disabled = true);
                    }
                });

                daysContainer.appendChild(row);
            });
        }

        async function saveSchedule(e) {
            e.preventDefault();
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const scheduleData = {};
            const rows = daysContainer.querySelectorAll('.day-row');
            
            rows.forEach(row => {
                const checkbox = row.querySelector('.day-check');
                const dayKey = checkbox.dataset.day;
                const start = row.querySelector('.time-start').value;
                const end = row.querySelector('.time-end').value;
                
                scheduleData[dayKey] = {
                    active: checkbox.checked,
                    start: start,
                    end: end
                };
            });

            const { error } = await supabaseClient
                .from('profiles')
                .update({ availability_json: scheduleData })
                .eq('id', user.id);

            if (error) {
                alert("Error saving schedule: " + error.message);
            } else {
                closeModal();
                displayRoutineStatus.textContent = "Active";
                displayRoutineStatus.style.color = "var(--success-color)";
                alert("Routine Updated! üìÖ");
            }
        }

        // --- UI HELPERS ---
        function showDashboard(session, profileData) {
            loginSection.classList.add('hidden');
            onboardingSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            
            if(profileData) {
                userNameDisplay.textContent = `Welcome, ${profileData.discord_name}`;
                if (profileData.avatar_url) userAvatarDisplay.src = profileData.avatar_url;
                displayPlaystyle.textContent = profileData.play_style;
                displayRegion.textContent = profileData.region;
            }
        }

        function showOnboarding(session) {
            loginSection.classList.add('hidden');
            dashboardSection.classList.add('hidden');
            onboardingSection.classList.remove('hidden');
        }

        function openModal() { scheduleModal.classList.remove('hidden'); }
        function closeModal() { scheduleModal.classList.add('hidden'); }

        // --- LISTENERS ---
        if (loginBtn) loginBtn.addEventListener('click', signInWithDiscord);
        if (logoutBtn) logoutBtn.addEventListener('click', signOut);
        if (profileForm) profileForm.addEventListener('submit', createProfile);
        
        if (editScheduleBtn) editScheduleBtn.addEventListener('click', openModal);
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if (scheduleForm) scheduleForm.addEventListener('submit', saveSchedule);

    </script>
</body>
</html>
