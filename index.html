<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Guild Tool</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #0f1012;
            --card-bg: #1a1c20;
            --modal-bg: #22252b;
            --accent-color: #ff4c29;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --border-color: #333;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --input-bg: #25282e;
        }

        /* --- GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: 4rem;
        }
        
        /* --- NAVIGATION --- */
        header {
            background-color: rgba(15, 16, 18, 0.95);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--accent-color); text-transform: uppercase; }
        nav ul { display: flex; gap: 20px; }
        nav a { font-size: 0.9rem; font-weight: 600; color: var(--text-dim); cursor: pointer; transition: color 0.3s; }
        nav a:hover, nav a.active { color: var(--accent-color); }
        .nav-external { color: #4cd1ff !important; }

        /* --- LAYOUT & UTILS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none !important; }
        .hero { text-align: center; padding: 4rem 1rem; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800; }

        /* --- CARDS & GRIDS --- */
        .card {
            background: var(--card-bg); padding: 2rem;
            border-radius: 8px; border: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        .grid-view {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px; margin-top: 2rem;
        }

        /* --- MEMBER & EVENT CARDS --- */
        .member-card, .event-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex; flex-direction: column; gap: 10px;
            position: relative;
        }
        
        .member-header {
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
        }
        .member-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            border: 2px solid var(--accent-color);
        }

        .event-date { color: var(--accent-color); font-weight: bold; font-size: 0.9rem; text-transform: uppercase; }
        .event-title { font-size: 1.4rem; font-weight: 800; margin: 5px 0; }
        .attendees-list {
            background: rgba(0,0,0,0.2); padding: 10px;
            border-radius: 4px; font-size: 0.9rem; margin-top: 10px;
        }
        .attendee-pill {
            display: inline-block; background: #333;
            padding: 2px 8px; border-radius: 12px;
            margin: 2px; font-size: 0.8rem;
        }
        .delete-event-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: var(--text-dim);
            cursor: pointer; font-size: 1.2rem;
        }
        .delete-event-btn:hover { color: var(--danger-color); }

        /* --- FORMS & BUTTONS --- */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dim); }
        input, select, textarea {
            width: 100%; padding: 10px; background: var(--input-bg);
            border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-main);
        }

        .btn-primary {
            background: var(--accent-color); color: white;
            padding: 10px 20px; border: none; border-radius: 4px;
            font-weight: 600; cursor: pointer; width: 100%;
        }
        .btn-secondary {
            background: transparent; border: 1px solid var(--accent-color);
            color: var(--accent-color); padding: 8px 16px; border-radius: 4px; cursor: pointer;
        }
        .btn-discord {
            background: #5865F2; color: white;
            padding: 12px 24px; border-radius: 4px; font-weight: 600; cursor: pointer; border: none;
        }
        .btn-action {
            width: 100%; margin-top: 10px; padding: 10px;
            border-radius: 4px; border: none; font-weight: bold; cursor: pointer;
        }
        .btn-join { background: var(--success-color); color: #0f1012; }
        .btn-leave { background: var(--card-bg); border: 1px solid var(--danger-color); color: var(--danger-color); }

        /* --- SCHEDULE EDITOR --- */
        .day-section {
            background: var(--bg-color); padding: 10px;
            border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--border-color);
        }
        .day-header { display: flex; justify-content: space-between; align-items: center; }
        .day-title-group { display: flex; gap: 10px; align-items: center; }
        .day-check { width: 20px; height: 20px; cursor: pointer; }
        .slots-container {
            padding-left: 30px; margin-top: 8px; display: flex; flex-direction: column; gap: 5px;
        }
        .time-slot { display: flex; gap: 5px; align-items: center; }
        .time-slot input { padding: 4px; font-size: 0.85rem; }
        .add-slot-btn {
            background: var(--card-bg); border: 1px solid var(--success-color);
            color: var(--success-color); border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
        }
        .remove-slot-btn {
            background: none; border: none; color: var(--danger-color);
            font-weight: bold; cursor: pointer; font-size: 1.2rem;
        }
        .disabled-day { opacity: 0.5; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--modal-bg); width: 95%; max-width: 500px;
            padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 10px; }
            .grid-view { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">RAIDER // SIGNAL</div>
        <nav>
            <ul>
                <li><a id="nav-home">Profile</a></li>
                <li><a id="nav-roster">Roster</a></li>
                <li><a id="nav-board">Raid Board</a></li>
                <li><a href="https://first-wave-bp-share.netlify.app/" target="_blank" class="nav-external">Blueprints ↗</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section id="login-section" class="hero hidden">
            <h1>Coordinate. Survive. Extract.</h1>
            <p>Connect with your guild to manage raid availability.</p>
            <button id="loginBtn" class="btn-discord">Login with Discord</button>
        </section>

        <section id="onboarding-section" class="card hidden">
            <h2>Operator Registration</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label>Preferred Playstyle</label>
                    <select id="p-style">
                        <option value="PvP">PvP</option>
                        <option value="PvE">PvE</option>
                        <option value="Hybrid">Hybrid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <select id="p-region">
                        <option value="NA">North America</option>
                        <option value="EU">Europe</option>
                        <option value="ASIA">Asia</option>
                        <option value="OC">Oceania</option>
                        <option value="SA">South America</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Initialize Profile</button>
            </form>
        </section>

        <section id="dashboard-section" class="card hidden">
            <div style="text-align:center">
                <img id="u-avatar" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--accent-color);">
                <h2 id="u-name">Welcome</h2>
                <p>
                    Playstyle: <strong id="u-playstyle">-</strong> | 
                    Region: <strong id="u-region">-</strong>
                </p>
                <button id="openScheduleBtn" class="btn-secondary" style="margin-top:1rem">Edit Weekly Schedule</button>
                <button id="logoutBtn" class="btn-secondary" style="margin-top:1rem; border-color:#333; color:#aaa">Logout</button>
            </div>
        </section>

        <section id="roster-section" class="hidden">
            <h2>Guild Roster</h2>
            <p style="color:#666; font-size:0.9rem">View who is active today.</p>
            <div id="rosterGrid" class="grid-view"></div>
        </section>

        <section id="board-section" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:1rem;">
                <h2>Mission Board</h2>
                <button id="openEventModalBtn" class="btn-primary" style="width:auto">+ Create Mission</button>
            </div>
            <div id="eventsGrid" class="grid-view"></div>
        </section>
    </main>

    <div id="scheduleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Weekly Availability</h3>
                <button class="close-modal" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer">&times;</button>
            </div>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:1rem">Set your "Standard" weekly hours.</p>
            <form id="scheduleForm">
                <div id="daysContainer"></div>
                <button type="submit" class="btn-primary" style="margin-top:1rem">Save Routine</button>
            </form>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Mission</h3>
                <button class="close-modal" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer">&times;</button>
            </div>
            <form id="eventForm">
                <div class="form-group">
                    <label>Mission Title</label>
                    <input id="e-title" required placeholder="e.g. Deep Dive Raid">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="e-desc" rows="3" placeholder="Objective details..."></textarea>
                </div>
                <div class="form-group">
                    <label>Start Time</label>
                    <input id="e-time" type="datetime-local" required>
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <select id="e-region">
                        <option>NA</option>
                        <option>EU</option>
                        <option>ASIA</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Post Mission</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const CONFIG = {
            url: 'https://olmaoftlbrookqwxvlvx.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sbWFvZnRsYnJvb2txd3h2bHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTI0MzQsImV4cCI6MjA4NTgyODQzNH0.D7iwaB1rQbQwNvQAlFkYsxW7G12zIQAHSlksFr3KxZo'
        };
        const supabaseClient = supabase.createClient(CONFIG.url, CONFIG.key);

        let currentUser = null;
        let profilesMap = {}; // Cache for user names

        // --- 2. NAVIGATION ---
        const pages = ['login', 'onboarding', 'dashboard', 'roster', 'board'];
        
        function navTo(pageId) {
            // Hide all sections
            pages.forEach(p => {
                const el = document.getElementById(p+'-section');
                if(el) el.classList.add('hidden');
            });
            
            // Show target section
            document.getElementById(pageId+'-section').classList.remove('hidden');
            
            // Update Tab Highlight
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            const navLink = document.getElementById('nav-'+(pageId === 'dashboard' ? 'home' : pageId));
            if(navLink) navLink.classList.add('active');

            // Trigger Page Loaders
            if(pageId === 'roster') loadRoster();
            if(pageId === 'board') loadBoard();
        }

        document.getElementById('nav-home').onclick = () => navTo('dashboard');
        document.getElementById('nav-roster').onclick = () => navTo('roster');
        document.getElementById('nav-board').onclick = () => navTo('board');

        // --- 3. AUTHENTICATION ---
        // Clean up URL hash if present (prevents loop)
        if (window.location.hash) {
            window.history.replaceState(null, null, window.location.pathname);
        }

        supabaseClient.auth.onAuthStateChange(async (e, session) => {
            if(session) {
                currentUser = session.user;
                await checkProfile();
            } else {
                navTo('login');
            }
        });

        document.getElementById('loginBtn').onclick = async () => {
            const cleanURL = window.location.origin + window.location.pathname;
            await supabaseClient.auth.signInWithOAuth({
                provider: 'discord', 
                options: { redirectTo: cleanURL }
            });
        };

        document.getElementById('logoutBtn').onclick = async () => {
            await supabaseClient.auth.signOut();
            window.location.reload();
        };

        // --- 4. PROFILE MANAGEMENT ---
        async function loadProfilesCache() {
            const { data } = await supabaseClient.from('profiles').select('id, discord_name');
            if(data) data.forEach(p => profilesMap[p.id] = p.discord_name);
        }

        async function checkProfile() {
            await loadProfilesCache(); // Pre-load names for other views
            
            const { data } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if(data) {
                // Profile Exists
                document.getElementById('u-name').textContent = data.discord_name;
                document.getElementById('u-avatar').src = data.avatar_url || 'https://placehold.co/50';
                document.getElementById('u-playstyle').textContent = data.play_style;
                document.getElementById('u-region').textContent = data.region;
                
                // IMPORTANT: Populate the schedule modal in background so it's ready
                if(data.availability_json) populateScheduleModal(data.availability_json);
                else populateScheduleModal(null);
                
                navTo('dashboard');
            } else {
                // No Profile
                navTo('onboarding');
            }
        }

        document.getElementById('profileForm').onsubmit = async (e) => {
            e.preventDefault();
            const { error } = await supabaseClient.from('profiles').upsert({
                id: currentUser.id,
                discord_name: currentUser.user_metadata.full_name || "Raider",
                avatar_url: currentUser.user_metadata.avatar_url,
                play_style: document.getElementById('p-style').value,
                region: document.getElementById('p-region').value
            });
            if(error) alert(error.message);
            else checkProfile();
        };

        // --- 5. ROSTER LOGIC ---
        async function loadRoster() {
            const grid = document.getElementById('rosterGrid');
            grid.innerHTML = '<p>Loading signals...</p>';
            
            const { data: profiles } = await supabaseClient.from('profiles').select('*');
            if(!profiles) return;

            grid.innerHTML = '';
            const today = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][new Date().getDay()];

            profiles.forEach(p => {
                let status = '<span style="color:#666">Offline Today</span>';
                
                if(p.availability_json && p.availability_json[today]) {
                    const dayData = p.availability_json[today];
                    if(dayData.active) {
                        const slots = Array.isArray(dayData.slots) ? dayData.slots : [{start:dayData.start, end:dayData.end}];
                        const times = slots.map(s => `${s.start}-${s.end}`).join(', ');
                        status = `<span style="color:var(--success-color)">Online: ${times}</span>`;
                    }
                }

                const card = document.createElement('div');
                card.className = 'member-card';
                card.innerHTML = `
                    <div class="member-header">
                        <img src="${p.avatar_url}" class="member-avatar">
                        <div>
                            <h3>${p.discord_name}</h3>
                            <div style="color:#aaa; font-size:0.8rem">${p.play_style} • ${p.region}</div>
                        </div>
                    </div>
                    <div style="margin-top:10px; font-weight:bold; font-size:0.9rem">${status}</div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 6. RAID BOARD LOGIC ---
        async function loadBoard() {
            const grid = document.getElementById('eventsGrid');
            grid.innerHTML = '<p>Scanning missions...</p>';
            
            const { data: events } = await supabaseClient.from('events').select('*').order('start_time', {ascending: true});
            const { data: signups } = await supabaseClient.from('event_signups').select('*');
            
            grid.innerHTML = '';
            if(!events || events.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color:#666; width:100%;">No active missions.</p>';
                return;
            }

            events.forEach(ev => {
                const hostName = profilesMap[ev.host_id] || 'Unknown';
                const evSignups = signups.filter(s => s.event_id === ev.id);
                const amISignedUp = evSignups.some(s => s.user_id === currentUser.id);
                const isHost = ev.host_id === currentUser.id;

                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    ${isHost ? `<button class="delete-event-btn" onclick="deleteEvent('${ev.id}')">&times;</button>` : ''}
                    <div class="event-date">${new Date(ev.start_time).toLocaleString()}</div>
                    <div class="event-title">${ev.title}</div>
                    <div style="color:#aaa; font-size:0.9rem">Host: ${hostName} (${ev.region})</div>
                    <p style="color:#ccc; font-size:0.9rem; margin-bottom:10px;">${ev.description || ''}</p>
                    
                    <div class="attendees-list">
                        <strong>Roster (${evSignups.length}):</strong><br>
                        ${evSignups.map(s => `<span class="attendee-pill">${profilesMap[s.user_id] || '...'}</span>`).join('')}
                    </div>

                    ${amISignedUp 
                        ? `<button class="btn-action btn-leave" onclick="leaveEvent('${ev.id}')">Withdraw</button>`
                        : `<button class="btn-action btn-join" onclick="joinEvent('${ev.id}')">Sign Up</button>`
                    }
                `;
                grid.appendChild(card);
            });
        }

        window.joinEvent = async (id) => {
            await supabaseClient.from('event_signups').insert({event_id: id, user_id: currentUser.id});
            loadBoard();
        };
        window.leaveEvent = async (id) => {
            await supabaseClient.from('event_signups').delete().match({event_id: id, user_id: currentUser.id});
            loadBoard();
        };
        window.deleteEvent = async (id) => {
            if(confirm('Delete this mission?')) {
                await supabaseClient.from('events').delete().eq('id', id);
                loadBoard();
            }
        };

        // --- 7. MODALS & FORMS ---
        const sModal = document.getElementById('scheduleModal');
        const eModal = document.getElementById('eventModal');

        document.getElementById('openScheduleBtn').onclick = () => sModal.classList.remove('hidden');
        document.getElementById('openEventModalBtn').onclick = () => eModal.classList.remove('hidden');
        
        document.querySelectorAll('.close-modal').forEach(b => {
            b.onclick = () => {
                sModal.classList.add('hidden');
                eModal.classList.add('hidden');
            }
        });

        // Event Submit
        document.getElementById('eventForm').onsubmit = async (e) => {
            e.preventDefault();
            const { error } = await supabaseClient.from('events').insert({
                title: document.getElementById('e-title').value,
                description: document.getElementById('e-desc').value,
                start_time: document.getElementById('e-time').value,
                region: document.getElementById('e-region').value,
                host_id: currentUser.id
            });
            if(error) alert(error.message);
            else { eModal.classList.add('hidden'); loadBoard(); }
        };

        // --- 8. SCHEDULE LOGIC (Multi-Slot) ---
        function populateScheduleModal(json) {
            const days = ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
            const cont = document.getElementById('daysContainer');
            cont.innerHTML = '';
            
            days.forEach(d => {
                const data = json ? json[d] : {};
                const active = data.active || false;
                let slots = [];
                if(Array.isArray(data.slots)) slots = data.slots;
                else if(data.start) slots.push({start:data.start, end:data.end});

                const dayDiv = document.createElement('div');
                dayDiv.className = `day-section ${active?'':'disabled-day'}`;
                dayDiv.innerHTML = `
                    <div class="day-header">
                        <div class="day-title-group">
                            <input type="checkbox" class="d-check" data-day="${d}" ${active?'checked':''}>
                            <strong style="text-transform:capitalize">${d}</strong>
                        </div>
                        <button type="button" class="add-slot-btn" ${active?'':'disabled'}>+</button>
                    </div>
                    <div class="slots-container ${active?'':'hidden'}"></div>
                `;
                
                const slotCont = dayDiv.querySelector('.slots-container');
                slots.forEach(s => addSlotUI(slotCont, s.start, s.end));

                // Day Checkbox Logic
                dayDiv.querySelector('.d-check').onchange = (e) => {
                    const checked = e.target.checked;
                    dayDiv.classList.toggle('disabled-day', !checked);
                    slotCont.classList.toggle('hidden', !checked);
                    dayDiv.querySelector('.add-slot-btn').disabled = !checked;
                    if(checked && slotCont.children.length === 0) addSlotUI(slotCont);
                };
                
                // Add Slot Button Logic
                dayDiv.querySelector('.add-slot-btn').onclick = () => addSlotUI(slotCont);
                
                cont.appendChild(dayDiv);
            });
        }

        function addSlotUI(cont, start="18:00", end="22:00") {
            const div = document.createElement('div');
            div.className = 'time-slot';
            div.innerHTML = `
                <input type="time" class="t-start" value="${start}"> - 
                <input type="time" class="t-end" value="${end}"> 
                <button type="button" class="remove-slot-btn">&times;</button>
            `;
            div.querySelector('.remove-slot-btn').onclick = () => div.remove();
            cont.appendChild(div);
        }

        // Schedule Submit
        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = {};
            document.querySelectorAll('.d-check').forEach(c => {
                const dayDiv = c.closest('.day-section');
                const slots = [];
                if(c.checked) {
                    dayDiv.querySelectorAll('.time-slot').forEach(s => {
                        slots.push({
                            start: s.querySelector('.t-start').value,
                            end: s.querySelector('.t-end').value
                        });
                    });
                }
                res[c.dataset.day] = { active: c.checked, slots: slots };
            });
            
            const { error } = await supabaseClient
                .from('profiles')
                .update({availability_json: res})
                .eq('id', currentUser.id);

            if(error) alert(error.message);
            else { sModal.classList.add('hidden'); checkProfile(); } // Reload profile to update UI
        };

    </script>
</body>
</html>
