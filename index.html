<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Guild Availability</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #0f1012;
            --card-bg: #1a1c20;
            --modal-bg: #22252b;
            --accent-color: #ff4c29;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --border-color: #333;
            --success-color: #2ecc71;
            --input-bg: #25282e;
            --danger-color: #e74c3c;
        }

        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
        }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }

        /* --- NAVIGATION --- */
        header {
            background-color: rgba(15, 16, 18, 0.95);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-color);
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }
        nav ul { display: flex; gap: 20px; }
        nav a { font-size: 0.9rem; font-weight: 600; color: var(--text-dim); transition: color 0.3s; }
        nav a:hover { color: var(--accent-color); }
        .nav-external { color: #4cd1ff !important; }

        /* --- LAYOUT --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .hero {
            text-align: center;
            padding: 4rem 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800; }
        .hero p { font-size: 1.1rem; color: var(--text-dim); margin-bottom: 2rem; }

        /* --- BUTTONS --- */
        .btn-discord {
            background-color: #5865F2;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        .btn-discord:hover { background-color: #4752C4; }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        .btn-secondary:hover { background-color: rgba(255, 76, 41, 0.1); }

        .btn-logout {
            background-color: var(--card-bg);
            color: var(--text-dim);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 2rem;
        }

        /* --- CARDS & FORMS --- */
        .card {
            max-width: 600px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            margin-top: 2rem;
        }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dim); }
        select, input {
            width: 100%; padding: 12px; background-color: var(--input-bg);
            border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-main); font-family: inherit;
        }
        
        .user-info { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .avatar { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent-color); }
        .status-badge {
            background: rgba(46, 204, 113, 0.2); color: var(--success-color);
            padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        .profile-details {
            margin-top: 1rem; text-align: left; width: 100%;
            background: var(--bg-color); padding: 1rem; border-radius: 4px;
        }
        .detail-row {
            display: flex; justify-content: space-between; margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;
        }

        /* --- MODAL (MULTI-SLOT STYLE) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--modal-bg); width: 95%; max-width: 600px;
            padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-btn { background: none; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; }
        
        /* Day Section */
        .day-section {
            background: var(--bg-color); padding: 10px; border-radius: 4px;
            margin-bottom: 10px; border: 1px solid var(--border-color);
        }
        .day-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .day-title-group { display: flex; align-items: center; gap: 10px; }
        .day-check { width: 20px; height: 20px; cursor: pointer; }
        .day-label { font-weight: bold; font-size: 1rem; }
        
        .add-slot-btn {
            background: var(--card-bg); border: 1px solid var(--success-color);
            color: var(--success-color); border-radius: 50%; width: 24px; height: 24px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }

        /* Time Slots List */
        .slots-container { display: flex; flex-direction: column; gap: 8px; padding-left: 30px; }
        .time-slot { display: flex; align-items: center; gap: 8px; }
        .time-slot input { padding: 4px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 4px; }
        .remove-slot-btn {
            background: none; border: none; color: var(--danger-color); font-weight: bold;
            cursor: pointer; font-size: 1.2rem; line-height: 1;
        }

        .disabled-day { opacity: 0.5; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 10px; }
            nav ul { gap: 15px; }
            .hero h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">RAIDER // SIGNAL</div>
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="https://first-wave-bp-share.netlify.app/" target="_blank" class="nav-external">Blueprint Tool ↗</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section id="login-section" class="hero">
            <h1>Coordinate. Survive. Extract.</h1>
            <p>Connect with your guild to manage raid availability.</p>
            <button id="loginBtn" class="btn-discord">Login with Discord</button>
        </section>

        <section id="onboarding-section" class="card hidden">
            <h2>Operator Registration</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label for="playstyle">Preferred Playstyle</label>
                    <select id="playstyle" required>
                        <option value="PvP">PvP</option>
                        <option value="PvE">PvE</option>
                        <option value="Hybrid">Hybrid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="region">Region</label>
                    <select id="region" required>
                        <option value="NA">North America</option>
                        <option value="EU">Europe</option>
                        <option value="ASIA">Asia</option>
                        <option value="OC">Oceania</option>
                        <option value="SA">South America</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Initialize Profile</button>
            </form>
        </section>
        
        <section id="dashboard-section" class="card hidden">
            <div class="user-info">
                <img id="userAvatar" src="" alt="Avatar" class="avatar">
                <h2 id="userName">Welcome, Raider</h2>
                <span class="status-badge">● SIGNAL ESTABLISHED</span>
            </div>
            <div class="profile-details">
                <div class="detail-row"><span>Playstyle:</span><strong id="displayPlaystyle">-</strong></div>
                <div class="detail-row"><span>Region:</span><strong id="displayRegion">-</strong></div>
                <div class="detail-row" style="border: none;"><span>Routine:</span><strong id="displayRoutineStatus">Not Set</strong></div>
            </div>
            <button id="editScheduleBtn" class="btn-secondary">Edit Weekly Schedule</button>
            <button id="logoutBtn" class="btn-logout">Disconnect Signal (Logout)</button>
        </section>
    </main>

    <div id="scheduleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Weekly Availability</h3>
                <button id="closeModalBtn" class="close-btn">&times;</button>
            </div>
            <p style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 1rem;">
                Add time slots for days you are active. You can add multiple slots per day.
            </p>
            <form id="scheduleForm">
                <div id="daysContainer"></div>
                <button type="submit" class="btn-primary">Save Routine</button>
            </form>
        </div>
    </div>

    <footer>
        &copy; 2026 Arc Raiders Guild Tool.
    </footer>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://olmaoftlbrookqwxvlvx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sbWFvZnRsYnJvb2txd3h2bHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTI0MzQsImV4cCI6MjA4NTgyODQzNH0.D7iwaB1rQbQwNvQAlFkYsxW7G12zIQAHSlksFr3KxZo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ---
        const loginSection = document.getElementById('login-section');
        const onboardingSection = document.getElementById('onboarding-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const scheduleModal = document.getElementById('scheduleModal');
        const daysContainer = document.getElementById('daysContainer');
        const editScheduleBtn = document.getElementById('editScheduleBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const scheduleForm = document.getElementById('scheduleForm');

        const userNameDisplay = document.getElementById('userName');
        const userAvatarDisplay = document.getElementById('userAvatar');
        const displayPlaystyle = document.getElementById('displayPlaystyle');
        const displayRegion = document.getElementById('displayRegion');
        const displayRoutineStatus = document.getElementById('displayRoutineStatus');

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

        // --- AUTH ---
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const currentURL = window.location.href; 
            await supabaseClient.auth.signInWithOAuth({
                provider: 'discord', options: { redirectTo: currentURL }
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut(); location.reload();
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session) checkProfile(session);
            else {
                loginSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                onboardingSection.classList.add('hidden');
            }
        });

        // --- PROFILE ---
        async function checkProfile(session) {
            const user = session.user;
            const { data } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();

            if (data) {
                showDashboard(session, data);
                if(data.availability_json) {
                    populateScheduleModal(data.availability_json);
                    displayRoutineStatus.textContent = "Active";
                    displayRoutineStatus.style.color = "var(--success-color)";
                } else {
                    populateScheduleModal(null);
                }
            } else {
                loginSection.classList.add('hidden');
                dashboardSection.classList.add('hidden');
                onboardingSection.classList.remove('hidden');
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { data: { user } } = await supabaseClient.auth.getUser();
            const playstyle = document.getElementById('playstyle').value;
            const region = document.getElementById('region').value;
            const discordName = user.user_metadata.full_name || "Raider";
            const avatarUrl = user.user_metadata.avatar_url;

            const { data, error } = await supabaseClient.from('profiles')
                .upsert({ id: user.id, discord_name: discordName, avatar_url: avatarUrl, play_style: playstyle, region: region })
                .select().single();

            if (!error) showDashboard(null, data);
        });

        // --- NEW MULTI-SLOT SCHEDULE LOGIC ---
        function populateScheduleModal(savedData) {
            daysContainer.innerHTML = ''; // Reset

            DAYS.forEach(day => {
                const dayKey = day.toLowerCase();
                const dayData = savedData ? savedData[dayKey] : null;
                // Old format support (if user has old data): convert {start, end} to [{start, end}]
                let slots = [];
                let isActive = false;

                if (dayData) {
                    if (Array.isArray(dayData.slots)) {
                        // New Format
                        slots = dayData.slots;
                        isActive = dayData.active;
                    } else if (dayData.start) {
                        // Migration for Old Format
                        isActive = dayData.active;
                        if(isActive) slots.push({ start: dayData.start, end: dayData.end });
                    }
                }

                // Create Day Section
                const daySection = document.createElement('div');
                daySection.className = `day-section ${isActive ? '' : 'disabled-day'}`;
                daySection.dataset.day = dayKey;

                // 1. Header
                const header = document.createElement('div');
                header.className = 'day-header';
                header.innerHTML = `
                    <div class="day-title-group">
                        <input type="checkbox" class="day-check" ${isActive ? 'checked' : ''}>
                        <span class="day-label">${day}</span>
                    </div>
                    <button type="button" class="add-slot-btn" title="Add Time Slot" ${isActive ? '' : 'disabled'}>+</button>
                `;

                // 2. Slots Container
                const slotsContainer = document.createElement('div');
                slotsContainer.className = 'slots-container';
                if (!isActive) slotsContainer.classList.add('hidden');

                // 3. Add Existing Slots
                slots.forEach(slot => {
                    addTimeSlotToUI(slotsContainer, slot.start, slot.end);
                });

                // --- Event Listeners ---
                const checkbox = header.querySelector('.day-check');
                const addBtn = header.querySelector('.add-slot-btn');

                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        daySection.classList.remove('disabled-day');
                        slotsContainer.classList.remove('hidden');
                        addBtn.disabled = false;
                        // Add one empty slot if none exist
                        if (slotsContainer.children.length === 0) {
                            addTimeSlotToUI(slotsContainer);
                        }
                    } else {
                        daySection.classList.add('disabled-day');
                        slotsContainer.classList.add('hidden');
                        addBtn.disabled = true;
                    }
                });

                addBtn.addEventListener('click', () => {
                    addTimeSlotToUI(slotsContainer);
                });

                daySection.appendChild(header);
                daySection.appendChild(slotsContainer);
                daysContainer.appendChild(daySection);
            });
        }

        function addTimeSlotToUI(container, startVal = "18:00", endVal = "22:00") {
            const slotRow = document.createElement('div');
            slotRow.className = 'time-slot';
            slotRow.innerHTML = `
                <input type="time" class="slot-start" value="${startVal}">
                <span>to</span>
                <input type="time" class="slot-end" value="${endVal}">
                <button type="button" class="remove-slot-btn" title="Remove">&times;</button>
            `;

            slotRow.querySelector('.remove-slot-btn').addEventListener('click', () => {
                slotRow.remove();
            });

            container.appendChild(slotRow);
        }

        async function saveSchedule(e) {
            e.preventDefault();
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            const scheduleData = {};
            
            // Loop through all day sections
            const daySections = daysContainer.querySelectorAll('.day-section');
            daySections.forEach(section => {
                const dayKey = section.dataset.day;
                const isActive = section.querySelector('.day-check').checked;
                const slotRows = section.querySelectorAll('.time-slot');
                
                const slots = [];
                if (isActive) {
                    slotRows.forEach(row => {
                        slots.push({
                            start: row.querySelector('.slot-start').value,
                            end: row.querySelector('.slot-end').value
                        });
                    });
                }

                scheduleData[dayKey] = {
                    active: isActive,
                    slots: slots // Saving array of slots now!
                };
            });

            console.log("Saving Multi-Slot Schedule:", scheduleData);

            const { error } = await supabaseClient.from('profiles')
                .update({ availability_json: scheduleData })
                .eq('id', user.id);

            if (error) alert("Error saving: " + error.message);
            else {
                scheduleModal.classList.add('hidden');
                displayRoutineStatus.textContent = "Active";
                displayRoutineStatus.style.color = "var(--success-color)";
            }
        }

        // --- LISTENERS ---
        editScheduleBtn.addEventListener('click', () => scheduleModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => scheduleModal.classList.add('hidden'));
        scheduleForm.addEventListener('submit', saveSchedule);

        function showDashboard(session, data) {
            loginSection.classList.add('hidden');
            onboardingSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            userNameDisplay.textContent = `Welcome, ${data.discord_name}`;
            if(data.avatar_url) userAvatarDisplay.src = data.avatar_url;
            displayPlaystyle.textContent = data.play_style;
            displayRegion.textContent = data.region;
        }

    </script>
</body>
</html>
