<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Guild Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-color: #0f1012; --card-bg: #1a1c20; --modal-bg: #22252b;
            --accent-color: #ff4c29; --text-main: #e0e0e0; --text-dim: #a0a0a0;
            --border-color: #333; --success-color: #2ecc71; --danger-color: #e74c3c;
            --input-bg: #25282e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); padding-bottom: 200px; }
        
        header {
            background: rgba(15, 16, 18, 0.95); border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--accent-color); text-transform: uppercase; }
        nav ul { display: flex; gap: 20px; }
        nav a { font-size: 0.9rem; font-weight: 600; color: var(--text-dim); cursor: pointer; transition: 0.3s; }
        nav a.active, nav a:hover { color: var(--accent-color); }
        .nav-external { color: #4cd1ff !important; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none !important; }
        .hero { text-align: center; padding: 4rem 1rem; }
        .card { background: var(--card-bg); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 2rem; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 2rem; }
        
        #mobile-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.9); border-top: 2px solid var(--accent-color);
            color: #0f0; font-family: monospace; font-size: 12px;
            overflow-y: scroll; padding: 10px; z-index: 9999; pointer-events: none;
        }
        .log-err { color: #ff4c29; font-weight: bold; }

        .btn-primary { background: var(--accent-color); color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-secondary { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-discord { background: #5865F2; color: white; padding: 12px 24px; border-radius: 4px; font-weight: 600; cursor: pointer; border: none; }
        .form-group { margin-bottom: 1rem; }
        input, select, textarea { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 4px; }
        
        .member-card, .event-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
        .delete-event-btn { float: right; background: none; border: none; color: #666; font-size: 1.2rem; }
        
        @media (max-width: 768px) { header { flex-direction: column; gap: 10px; } .grid-view { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="mobile-console"><strong>// SYSTEM LOG INITIALIZED...</strong><br></div>

<header>
    <div class="logo">RAIDER // SIGNAL</div>
    <nav>
        <ul>
            <li><a id="nav-home">Profile</a></li>
            <li><a id="nav-roster">Roster</a></li>
            <li><a id="nav-board">Raid Board</a></li>
        </ul>
    </nav>
</header>

<main class="container">
    <section id="login-section" class="hero hidden">
        <h1>Coordinate. Survive. Extract.</h1>
        <button id="loginBtn" class="btn-discord">Login with Discord</button>
    </section>

    <section id="onboarding-section" class="card hidden">
        <h2>Registration</h2>
        <form id="profileForm">
            <div class="form-group"><label>Playstyle</label><select id="p-style"><option>PvP</option><option>PvE</option><option>Hybrid</option></select></div>
            <div class="form-group"><label>Region</label><select id="p-region"><option>NA</option><option>EU</option><option>ASIA</option></select></div>
            <button type="submit" class="btn-primary">Initialize</button>
        </form>
    </section>

    <section id="dashboard-section" class="card hidden">
        <div style="text-align:center">
            <img id="u-avatar" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--accent-color);">
            <h2 id="u-name">Welcome</h2>
            <p>Playstyle: <strong id="u-playstyle">-</strong> | Region: <strong id="u-region">-</strong></p>
            <button id="logoutBtn" class="btn-secondary" style="margin-top:1rem; border-color:#333; color:#aaa">Logout</button>
        </div>
    </section>

    <section id="roster-section" class="hidden"><h2>Guild Roster</h2><div id="rosterGrid" class="grid-view"></div></section>
    
    <section id="board-section" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Mission Board</h2><button id="openEventModalBtn" class="btn-primary" style="width:auto">+ Create</button>
        </div>
        <div id="eventsGrid" class="grid-view"></div>
    </section>
</main>

<div id="eventModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:200; justify-content:center; align-items:center;">
    <div style="background:#22252b; width:95%; max-width:500px; padding:1.5rem; border-radius:8px;">
        <h3>New Mission</h3>
        <form id="eventForm">
            <div class="form-group"><input id="e-title" required placeholder="Title"></div>
            <div class="form-group"><input id="e-time" type="datetime-local" required></div>
            <div class="form-group"><select id="e-region"><option>NA</option><option>EU</option></select></div>
            <button type="submit" class="btn-primary">Post</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('eventModal').style.display='none'" style="margin-top:10px; width:100%">Cancel</button>
        </form>
    </div>
</div>

<script>
    // --- LOGGER ---
    const consoleBox = document.getElementById('mobile-console');
    function log(msg, type='info') {
        const line = document.createElement('div');
        line.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
        if(type==='error') line.className = 'log-err';
        consoleBox.appendChild(line);
        consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    const CONFIG = {
        url: 'https://olmaoftlbrookqwxvlvx.supabase.co',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sbWFvZnRsYnJvb2txd3h2bHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTI0MzQsImV4cCI6MjA4NTgyODQzNH0.D7iwaB1rQbQwNvQAlFkYsxW7G12zIQAHSlksFr3KxZo'
    };
    const supabaseClient = supabase.createClient(CONFIG.url, CONFIG.key);
    let currentUser = null;
    let profilesMap = {};

    // --- NAV ---
    function navTo(pageId) {
        log(`Nav: ${pageId}`);
        ['login','onboarding','dashboard','roster','board'].forEach(p => {
            const el = document.getElementById(p+'-section');
            if(el) el.classList.add('hidden');
        });
        document.getElementById(pageId+'-section').classList.remove('hidden');
        if(pageId === 'roster') loadRoster();
        if(pageId === 'board') loadBoard();
    }
    document.getElementById('nav-home').onclick = () => navTo('dashboard');
    document.getElementById('nav-roster').onclick = () => navTo('roster');
    document.getElementById('nav-board').onclick = () => navTo('board');

    // --- AUTH ---
    // FIXED: Removed the aggressive hash clearing line!
    
    supabaseClient.auth.onAuthStateChange(async (e, session) => {
        log(`Auth Event: ${e}`);
        if(session) {
            currentUser = session.user;
            log(`Logged in as: ${currentUser.id}`);
            await checkProfile();
        } else {
            navTo('login');
        }
    });

    document.getElementById('loginBtn').onclick = async () => {
        const cleanURL = window.location.origin + window.location.pathname;
        await supabaseClient.auth.signInWithOAuth({ provider:'discord', options:{ redirectTo: cleanURL } });
    };
    document.getElementById('logoutBtn').onclick = async () => {
        await supabaseClient.auth.signOut(); window.location.reload();
    };

    // --- DATA ---
    async function checkProfile() {
        log("Checking Profile...");
        const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
        
        if(data) {
            document.getElementById('u-name').textContent = data.discord_name;
            document.getElementById('u-avatar').src = data.avatar_url || 'https://placehold.co/50';
            document.getElementById('u-playstyle').textContent = data.play_style;
            document.getElementById('u-region').textContent = data.region;
            navTo('dashboard');
        } else if (error && error.code === 'PGRST116') {
            log("No profile found. Loading Onboarding.");
            navTo('onboarding');
        } else {
            log(`Profile Error: ${error.message}`, 'error');
        }
    }

    document.getElementById('profileForm').onsubmit = async (e) => {
        e.preventDefault();
        const { error } = await supabaseClient.from('profiles').upsert({
            id: currentUser.id,
            discord_name: currentUser.user_metadata.full_name || "Raider",
            avatar_url: currentUser.user_metadata.avatar_url,
            play_style: document.getElementById('p-style').value,
            region: document.getElementById('p-region').value
        });
        if(error) log(error.message, 'error'); else checkProfile();
    };

    // --- ROSTER ---
    async function loadRoster() {
        const grid = document.getElementById('rosterGrid');
        grid.innerHTML = 'Loading...';
        const { data, error } = await supabaseClient.from('profiles').select('*');
        if(error) { log(error.message, 'error'); return; }
        grid.innerHTML = '';
        data.forEach(p => {
            grid.innerHTML += `<div class="member-card"><strong>${p.discord_name}</strong><br>${p.play_style} â€¢ ${p.region}</div>`;
        });
    }

    // --- BOARD ---
    async function loadBoard() {
        log("Loading Board...");
        const grid = document.getElementById('eventsGrid');
        const { data: events, error } = await supabaseClient.from('events').select('*');
        
        if(error) { log(error.message, 'error'); return; }
        
        grid.innerHTML = '';
        if(events.length === 0) grid.innerHTML = '<p>No active missions.</p>';
        
        // Cache profiles for names
        const { data: profiles } = await supabaseClient.from('profiles').select('id, discord_name');
        const pMap = {};
        if(profiles) profiles.forEach(p => pMap[p.id] = p.discord_name);

        events.forEach(ev => {
            const hostName = pMap[ev.host_id] || 'Unknown';
            const isHost = ev.host_id === currentUser.id;
            grid.innerHTML += `
                <div class="event-card">
                    ${isHost ? `<button class="delete-event-btn" onclick="deleteEvent('${ev.id}')">&times;</button>` : ''}
                    <strong>${ev.title}</strong>
                    <span style="color:#aaa">${new Date(ev.start_time).toLocaleString()}</span>
                    <span>Host: ${hostName} (${ev.region})</span>
                </div>`;
        });
    }

    window.deleteEvent = async (id) => {
        if(confirm('Delete?')) {
            await supabaseClient.from('events').delete().eq('id', id);
            loadBoard();
        }
    };

    document.getElementById('openEventModalBtn').onclick = () => document.getElementById('eventModal').style.display='flex';
    document.getElementById('eventForm').onsubmit = async (e) => {
        e.preventDefault();
        const { error } = await supabaseClient.from('events').insert({
            title: document.getElementById('e-title').value,
            start_time: document.getElementById('e-time').value,
            region: document.getElementById('e-region').value,
            host_id: currentUser.id
        });
        if(error) log(error.message, 'error');
        else { document.getElementById('eventModal').style.display='none'; loadBoard(); }
    };

</script>
</body>
</html>
