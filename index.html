<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arc Raiders Guild Tool</title>
    
    <meta property="og:title" content="RAIDER // SIGNAL">
    <meta property="og:description" content="Tactical Coordination Suite.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://i.imgur.com/8Q5QY5M.png">
    <meta name="theme-color" content="#ff5500">

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>

    <style>
        :root { --bg-color: #050505; --card-bg: #111111; --accent-color: #ff5500; --text-main: #ffffff; --text-dim: #888888; --border-color: #333333; --success-color: #00ff41; --danger-color: #ff3333; --input-bg: #0a0a0a; --cal-color: #00d9ff; --admin-color: #ff00ea; --locked-color: #ffaa00; --info-color: #00e5ff; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Share Tech Mono', monospace; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 4rem; overflow-x: hidden; font-size: 18px; font-weight: 500; line-height: 1.5; }
        .scanlines { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.4; }
        
        header { background-color: rgba(5, 5, 5, 0.95); border-bottom: 3px solid var(--accent-color); padding: 1.5rem 2rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2.2rem; letter-spacing: 2px; color: var(--accent-color); font-weight: 700; text-shadow: 0 0 10px rgba(255,85,0,0.5); }
        nav ul { display: flex; gap: 30px; }
        nav a { font-size: 1.2rem; color: var(--text-dim); cursor: pointer; transition: 0.2s; font-weight: 600; text-transform: uppercase; text-decoration: none; }
        nav a:hover, nav a.active { color: var(--text-main); text-shadow: 0 0 8px var(--text-main); border-bottom: 2px solid var(--accent-color); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none !important; }
        .hero { text-align: center; padding: 6rem 1rem; }
        .hero h1 { font-size: 3.5rem; margin-bottom: 1rem; font-weight: 700; text-shadow: 0 0 15px rgba(255,255,255,0.3); }
        
        .card, .member-card, .event-card, .config-card { background: var(--card-bg); border: 2px solid var(--border-color); border-left: 6px solid var(--border-color); padding: 2rem; margin-top: 2rem; position: relative; }
        .config-card { border-left-color: var(--admin-color); }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 2rem; }
        .event-card { border-left-color: var(--accent-color); }
        .locked-screen { text-align: center; padding: 4rem; border: 2px solid var(--locked-color); background: rgba(255, 170, 0, 0.05); color: var(--locked-color); margin-top: 2rem; }
        
        .countdown-timer { font-size: 1.5rem; color: var(--success-color); font-weight: bold; background: rgba(0, 255, 65, 0.1); padding: 5px 10px; display: inline-block; border: 1px solid var(--success-color); margin-bottom: 10px; }
        .time-display-group { background: #080808; padding: 10px; border: 1px solid var(--border-color); margin: 10px 0; }
        .local-time { color: var(--text-main); font-size: 1.2rem; font-weight: bold; }
        .host-time { color: var(--text-dim); font-size: 0.9rem; margin-top: 4px; }
        .attendees-list { background: #0a0a0a; padding: 10px; border: 1px solid var(--border-color); margin-top: 10px; }
        .attendee-pill { display: inline-block; background: #333; padding: 2px 8px; border-radius: 12px; margin: 2px; font-size: 0.8rem; }
        .mission-type { color: var(--accent-color); text-transform: uppercase; font-weight: bold; border: 1px solid var(--accent-color); padding: 2px 6px; font-size: 0.9rem; display: inline-block; margin-bottom: 5px; }
        .condition-tags { display: flex; flex-wrap: wrap; gap: 5px; margin: 5px 0; }
        .condition-tag { font-size: 0.8rem; background: #222; color: #ccc; padding: 2px 6px; border: 1px solid #444; }
        
        button { font-family: 'Share Tech Mono', monospace; text-transform: uppercase; cursor: pointer; border: 1px solid transparent; font-size: 1rem; font-weight: 700; transition: 0.2s; }
        .btn-primary { background: var(--accent-color); color: #000; padding: 14px 28px; width: 100%; }
        .btn-primary:hover { background: #fff; color: var(--accent-color); box-shadow: 0 0 15px var(--accent-color); }
        .btn-discord { background: #5865F2; color: white; padding: 14px 30px; border: none; font-size: 1.2rem; }
        .btn-secondary { background: transparent; border: 2px solid var(--text-dim); color: var(--text-dim); padding: 10px 20px; margin-top: 1rem; }
        .btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-join { background: transparent; border: 2px solid var(--success-color); color: var(--success-color); width: 100%; padding: 12px; margin-top:10px; }
        .btn-join:hover { background: var(--success-color); color: #000; }
        .btn-leave { background: transparent; border: 2px solid var(--danger-color); color: var(--danger-color); width: 100%; padding: 12px; margin-top:10px; }
        .btn-leave:hover { background: var(--danger-color); color: #000; }
        .btn-sync { background: transparent; border: 1px solid var(--cal-color); color: var(--cal-color); padding: 5px 10px; font-size: 0.8rem; flex: 1; margin-top:10px; }
        .btn-sync:hover { background: var(--cal-color); color: #000; }
        .btn-admin-delete { position: absolute; top: 15px; right: 15px; background: var(--admin-color); color: #000; font-size: 0.8rem; padding: 4px 8px; border: none; }
        .btn-admin-kick { display: block; margin-top: 10px; background: #000; border: 1px solid var(--admin-color); color: var(--admin-color); width: 100%; font-size: 0.8rem; }
        .btn-admin-approve { display: block; margin-top: 10px; background: var(--success-color); color: #000; width: 100%; font-size: 0.9rem; padding: 8px; border: none; }
        .btn-admin-approve:hover { background: #fff; box-shadow: 0 0 10px var(--success-color); }
        
        .form-group { margin-bottom: 1.5rem; }
        /* LABELS & TOOLTIPS (UPDATED FOR MOBILE) */
        label { display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .help-trigger { color: var(--info-color); cursor: help; font-size: 0.9rem; text-decoration: underline; text-underline-offset: 4px; text-decoration-style: dotted; padding: 5px; /* Added padding for touch targets */ }
        .help-icon { color: var(--text-dim); cursor: pointer; font-size: 1rem; padding: 5px 10px; /* Larger hit area */ background: rgba(0,229,255,0.1); border-radius: 4px; }
        .help-icon:hover, .help-icon:active { color: var(--info-color); background: rgba(0,229,255,0.2); }

        input, select, textarea { width: 100%; padding: 14px; background: var(--input-bg); border: 2px solid var(--border-color); color: var(--text-main); font-family: 'Share Tech Mono', monospace; font-size: 1.1rem; font-weight: 600; }
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #080808; padding: 10px; border: 1px solid var(--border-color); }
        .checkbox-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .checkbox-item input { width: 18px; height: 18px; }
        
        .roster-toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: #080808; border: 1px solid var(--border-color); }
        .toolbar-group { flex: 1; min-width: 200px; }
        .toolbar-group input, .toolbar-group select { padding: 8px; font-size: 0.9rem; }
        .toolbar-toggle { display: flex; align-items: center; gap: 10px; color: var(--text-dim); font-size: 0.9rem; cursor: pointer; user-select: none; }
        .toolbar-toggle input { width: 18px; height: 18px; }

        .admin-table-container { overflow-x: auto; background: var(--card-bg); border: 2px solid var(--admin-color); padding: 1rem; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .admin-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color); color: var(--text-dim); font-weight: normal; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #222; }
        .admin-table tr:hover { background: #1a1a1a; }
        .status-verified { color: var(--success-color); }
        .status-pending { color: var(--locked-color); font-weight: bold; }
        .mini-btn { padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; border: 1px solid; background: transparent; cursor: pointer; }
        .btn-green { color: var(--success-color); border-color: var(--success-color); }
        .btn-green:hover { background: var(--success-color); color: #000; }
        .btn-red { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-red:hover { background: var(--danger-color); color: #000; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #000; width: 95%; max-width: 600px; padding: 2.5rem; border: 3px solid var(--accent-color); box-shadow: 0 0 40px rgba(255, 85, 0, 0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { background: none; border: none; color: var(--accent-color); font-size: 2rem; }
        .day-section { border: 2px solid var(--border-color); padding: 15px; margin-bottom: 15px; background: #080808; }
        .day-header { display: flex; align-items: center; justify-content: space-between; }
        .time-slot { margin-top: 10px; display: flex; gap: 10px; align-items: center; padding-left: 20px; }
        .add-slot-btn { background: #111; border: 1px solid var(--success-color); color: var(--success-color); width: 30px; height: 30px; }
        .disabled-day { opacity: 0.3; }

        @media (max-width: 768px) { header { flex-direction: column; gap: 15px; } .grid-view { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <header>
        <div class="logo">RAIDER // SIGNAL</div>
        <nav>
            <ul id="main-nav">
                <li><a id="nav-home">ID Card</a></li>
                <li><a id="nav-roster">Roster</a></li>
                <li><a id="nav-board">Missions</a></li>
                <li><a href="https://first-wave-bp-share.netlify.app/" target="_blank">Blueprints</a></li>
                <li id="nav-admin-li" style="display:none"><a id="nav-admin" style="color:var(--admin-color); font-weight:bold; border-bottom:2px solid var(--admin-color);">COMMAND</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section id="login-section" class="hero">
            <h1>COORDINATE // SURVIVE</h1>
            <p style="color:var(--text-dim); margin-bottom: 2rem; font-size: 1.2rem;">SECURE UPLINK REQUIRED FOR GUILD ACCESS</p>
            <button id="loginBtn" class="btn-discord">:: INITIALIZE UPLINK (DISCORD) ::</button>
            <p id="loading-msg" style="color:var(--accent-color); margin-top:20px; display:none;">> ESTABLISHING CONNECTION...</p>
        </section>

        <section id="onboarding-section" class="card hidden">
            <h2 style="color:var(--accent-color); margin-bottom:1rem;">// OPERATOR REGISTRATION</h2>
            <p style="color:var(--text-dim); margin-bottom:1rem;">PROFILE INCOMPLETE. PLEASE UPDATE YOUR CREDENTIALS.</p>
            <form id="profileForm">
                <div class="form-group">
                    <label>EMBARK ID (OPTIONAL) <span class="help-icon" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('embark')">[?]</span></label>
                    <input id="p-embark-id" placeholder="Name#1234">
                </div>
                <div class="form-group"><label>COMBAT PREFERENCE <span class="help-icon" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('playstyle')">[?]</span></label><select id="p-style"><option value="PvP">PvP (HOSTILE)</option><option value="PvE">PvE (ENVIRONMENT)</option><option value="Hybrid">HYBRID</option></select></div>
                <div class="form-group"><label>DEPLOYMENT REGION</label><select id="p-region"><option value="NA">NORTH AMERICA</option><option value="EU">EUROPE</option><option value="ASIA">ASIA</option><option value="OTHER">GLOBAL / OTHER</option></select></div>
                <div class="form-group"><label>LOCAL TIMEZONE</label><select id="p-timezone"></select></div>
                <button type="submit" class="btn-primary">CREATE ID CARD</button>
            </form>
        </section>

        <section id="locked-section" class="hidden">
            <div class="locked-screen">
                <div class="locked-icon">üîí</div>
                <h2>ACCESS DENIED // VERIFICATION FAILED</h2>
                <p id="locked-reason" style="margin-top:20px; font-size:1.1rem; color:var(--danger-color);">TOKEN EXPIRED OR MISSING.</p>
                <div id="scan-progress" style="display:none; margin:20px 0; color:var(--success-color);">[==== SCANNING GUILD LIST ====]</div>
                <p style="color:var(--text-dim); margin-top:20px;">YOU MUST BE IN THE GUILD DISCORD TO ACCESS THIS TOOL.</p>
                <button id="retryScanBtn" class="btn-primary" style="margin-top:20px; width:auto; display:inline-block;">RE-AUTHENTICATE (DISCORD)</button>
                <button id="lockedLogoutBtn" class="btn-secondary" style="border-color:var(--danger-color); color:var(--danger-color); margin-left:10px; width:auto; display:inline-block;">LOGOUT</button>
            </div>
        </section>

        <section id="dashboard-section" class="card hidden" style="text-align:center;">
            <div style="border: 2px solid var(--accent-color); display:inline-block; padding:5px; border-radius:50%;">
                <img id="u-avatar" style="width:100px; height:100px; border-radius:50%; display:block;">
            </div>
            <h2 id="u-name" style="font-size:2.5rem; margin-top:15px; font-weight:800;">UNKNOWN</h2>
            <div id="u-embark-display" style="font-size:1.2rem; color:var(--text-dim); margin-bottom:10px; letter-spacing:1px;"></div>
            
            <div style="color:var(--text-dim); margin-bottom:20px; font-size:1.1rem;">
                STYLE: <strong id="u-playstyle" style="color:var(--text-main)">-</strong> // 
                REGION: <strong id="u-region" style="color:var(--text-main)">-</strong> //
                TZ: <strong id="u-timezone" style="color:var(--accent-color)">-</strong>
            </div>
            <div id="admin-badge" style="display:none; color:var(--admin-color); font-weight:bold; margin-bottom:20px; border:1px solid var(--admin-color); padding:5px; display:inline-block;">[COMMANDER ACCESS GRANTED]</div>
            <br>
            <button id="repairProfileBtn" class="btn-primary" style="display:none; margin-bottom:20px; background:var(--danger-color); color:white;">‚ö†Ô∏è REPAIR MISSING PROFILE DATA</button>
            
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button id="openScheduleBtn" class="btn-secondary">EDIT SCHEDULE</button>
                <button id="openProfileModalBtn" class="btn-secondary">EDIT PROFILE</button>
            </div>
            <button id="logoutBtn" class="btn-secondary" style="border-color:var(--danger-color); color:var(--danger-color); margin-top:2rem;">TERMINATE LINK</button>
        </section>

        <section id="roster-section" class="hidden">
            <h2 style="border-bottom:2px solid var(--border-color); padding-bottom:10px;">// ACTIVE AGENTS</h2>
            <div class="roster-toolbar">
                <div class="toolbar-group"><input type="text" id="roster-search" placeholder="SEARCH NAME OR ID..."></div>
                <div class="toolbar-group">
                    <select id="roster-filter-region">
                        <option value="ALL">REGION: ALL</option>
                        <option value="NA">REGION: NA</option>
                        <option value="EU">REGION: EU</option>
                        <option value="ASIA">REGION: ASIA</option>
                        <option value="OTHER">REGION: GLOBAL</option>
                    </select>
                </div>
                <div class="toolbar-group">
                    <select id="roster-filter-style">
                        <option value="ALL">STYLE: ALL</option>
                        <option value="PvP">STYLE: PvP</option>
                        <option value="PvE">STYLE: PvE</option>
                        <option value="Hybrid">STYLE: HYBRID</option>
                    </select>
                </div>
                <label id="pending-toggle-label" class="toolbar-toggle" style="display:none;">
                    <input type="checkbox" id="roster-show-pending"> SHOW PENDING REQUESTS
                </label>
            </div>
            <div id="rosterGrid" class="grid-view"></div>
        </section>

        <section id="admin-section" class="hidden">
            <h2 style="color:var(--admin-color)">// COMMAND CENTER</h2>
            
            <div class="config-card">
                <h3 style="color:var(--text-main); border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:15px;">SYSTEM CONFIGURATION</h3>
                <div class="form-group">
                    <label class="help-trigger" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('guild_id')">TARGET GUILD ID [?]</label>
                    <input id="cfg-guild-id" placeholder="Discord Server ID">
                </div>
                <div class="form-group">
                    <label class="help-trigger" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('webhook')">WEBHOOK URL [?]</label>
                    <input id="cfg-webhook" placeholder="https://discord.com/api/webhooks/...">
                </div>
                <div class="checkbox-grid">
                    <label class="checkbox-item"><input type="checkbox" id="cfg-auto-approve"> <span class="help-trigger" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('auto_approve')">AUTO-APPROVE NEW RECRUITS [?]</span></label>
                </div>
                <button id="saveConfigBtn" class="btn-primary" style="margin-top:15px; width:auto;">SAVE CONFIGURATION</button>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; margin-top:40px;">
                <h3 style="color:var(--text-dim)">PERSONNEL DATABASE</h3>
                <button id="refreshAdminBtn" class="mini-btn" style="color:var(--text-main); border:1px solid var(--text-dim)">REFRESH DATA</button>
            </div>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>AGENT</th>
                            <th>EMBARK ID</th>
                            <th>REGION / STYLE</th>
                            <th>STATUS</th>
                            <th>JOINED</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="board-section" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--border-color); padding-bottom:1rem;">
                <h2>// MISSION PARAMETERS</h2><button id="openEventModalBtn" class="btn-primary" style="width:auto">+ NEW OP</button>
            </div>
            <div id="eventsGrid" class="grid-view"></div>
        </section>
    </main>

    <footer style="text-align:center; margin-top:50px; opacity:0.5; font-size:0.9rem;">
        SYSTEM v19.2 // <button id="resetAppBtn" style="background:none; border:none; color:var(--danger-color); text-decoration:underline; cursor:pointer; font-weight:bold;">FORCE RESET</button>
    </footer>

    <div id="infoModal" class="modal-overlay hidden">
        <div class="modal-content" style="border-color:var(--info-color)">
            <div class="modal-header">
                <h3 id="infoTitle" style="color:var(--info-color)">INTEL</h3>
                <button class="close-modal" style="color:var(--info-color)">[X]</button>
            </div>
            <div id="infoBody" style="line-height:1.6; color:var(--text-main);"></div>
            <button class="close-modal btn-secondary" style="width:100%; margin-top:20px; border-color:var(--info-color); color:var(--info-color)">ACKNOWLEDGE</button>
        </div>
    </div>

    <div id="scheduleModal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><h3>AVAILABILITY PROTOCOL</h3><button class="close-modal">[X]</button></div><form id="scheduleForm"><div id="daysContainer"></div><button type="submit" class="btn-primary" style="margin-top:1rem">UPDATE RECORD</button></form></div></div>
    
    <div id="profileModal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><h3>EDIT ID CARD</h3><button class="close-modal">[X]</button></div><form id="editProfileForm">
        <div class="form-group"><label>EMBARK ID (OPTIONAL) <span class="help-icon" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('embark')">[?]</span></label><input id="ep-embark-id" placeholder="Name#1234"></div>
        <div class="form-group"><label>COMBAT PREFERENCE <span class="help-icon" onclick="event.preventDefault(); event.stopPropagation(); window.showHelp('playstyle')">[?]</span></label><select id="ep-style"><option value="PvP">PvP (HOSTILE)</option><option value="PvE">PvE (ENVIRONMENT)</option><option value="Hybrid">HYBRID</option></select></div>
        <div class="form-group"><label>DEPLOYMENT REGION</label><select id="ep-region"><option value="NA">NORTH AMERICA</option><option value="EU">EUROPE</option><option value="ASIA">ASIA</option><option value="OTHER">GLOBAL / OTHER</option></select></div>
        <div class="form-group"><label>LOCAL TIMEZONE</label><select id="ep-timezone"></select></div>
        <button type="submit" class="btn-primary">SAVE CHANGES</button>
    </form></div></div>
    
    <div id="eventModal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><h3>MISSION BRIEFING</h3><button class="close-modal">[X]</button></div><form id="eventForm"><div class="form-group"><label>OPERATION NAME</label><input id="e-title" required></div><div class="form-group"><label>MISSION TYPE</label><select id="e-type"><option value="Standard Raid">Standard Raid (30m)</option><option value="Locked Gate">Locked Gate (40m)</option><option value="Hidden Bunker">Hidden Bunker (30m)</option><option value="Matriarch">Matriarch Boss (30m)</option><option value="Harvester">Harvester (30m)</option></select></div><div class="form-group"><label>DETAILS</label><textarea id="e-desc" rows="3"></textarea></div><div class="form-group"><label>T-MINUS (TIME)</label><input id="e-time" type="datetime-local" required></div><div class="form-group"><label>MISSION TIMEZONE</label><select id="e-timezone"></select></div><div class="form-group"><label>THEATER</label><select id="e-region"><option>NA</option><option>EU</option><option>OTHER</option></select></div><div class="form-group"><label>CONDITIONS</label><div class="checkbox-grid"><div class="checkbox-item"><input type="checkbox" name="cond" value="Bird City"> Bird City</div><div class="checkbox-item"><input type="checkbox" name="cond" value="Night Raid"> Night Raid</div><div class="checkbox-item"><input type="checkbox" name="cond" value="EM Storm"> EM Storm</div><div class="checkbox-item"><input type="checkbox" name="cond" value="Lush Blooms"> Lush Blooms</div><div class="checkbox-item"><input type="checkbox" name="cond" value="Husk Graveyard"> Husk Graveyard</div><div class="checkbox-item"><input type="checkbox" name="cond" value="Uncovered Caches"> Uncovered Caches</div><div class="checkbox-item"><input type="checkbox" name="cond" value="Launch Tower"> Launch Tower Loot</div></div></div><button type="submit" class="btn-primary">INITIATE MISSION</button></form></div></div>

    <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(e=>console.log(e));});}</script>

    <script>
        window.onerror = function(msg, url, line) { alert("SYSTEM ERROR: " + msg + "\nLine: " + line); return false; };

        // --- HELP SYSTEM ---
        const HELP_DB = {
            'guild_id': {
                title: "TARGET GUILD ID SETUP",
                text: "To locate this ID:<br>1. Open Discord Settings > Advanced.<br>2. Toggle <strong>Developer Mode</strong> ON.<br>3. Right-click your Server Icon on the left sidebar.<br>4. Select <strong>Copy Server ID</strong>.<br><br>This ensures only members of that specific server can access this tool."
            },
            'webhook': {
                title: "WEBHOOK CONFIGURATION",
                text: "To create a Webhook:<br>1. Go to Server Settings > Integrations > Webhooks.<br>2. Create a new Webhook.<br>3. Click <strong>Copy Webhook URL</strong>.<br><br>Paste the URL here to automatically post new mission alerts to that channel."
            },
            'auto_approve': {
                title: "AUTO-APPROVAL PROTOCOL",
                text: "<strong>ENABLED:</strong> Any user who logs in and is confirmed to be a member of the Target Guild will be instantly Verified and granted access.<br><br><strong>DISABLED:</strong> New users will be set to 'Pending' status. An Admin must manually approve them in the Command Center."
            },
            'embark': {
                title: "EMBARK ID FORMAT",
                text: "Your unique in-game identifier found in the Social menu.<br>Format: <strong>DisplayName#1234</strong><br>This helps squadmates find and invite you in-game."
            },
            'playstyle': {
                title: "COMBAT PREFERENCE",
                text: "<strong>PvP:</strong> You actively seek hostile engagements.<br><strong>PvE:</strong> You focus on quests and looting, avoiding players.<br><strong>Hybrid:</strong> You adapt to the mission requirements."
            }
        };

        window.showHelp = function(key) {
            const data = HELP_DB[key];
            if(data) {
                document.getElementById('infoTitle').innerHTML = data.title;
                document.getElementById('infoBody').innerHTML = data.text;
                document.getElementById('infoModal').classList.remove('hidden');
            }
        };

        document.addEventListener("DOMContentLoaded", async () => {
            console.log("üöÄ ARC SYSTEM v19.2 [MOBILE PATCH] ONLINE...");
            
            try { dayjs.extend(window.dayjs_plugin_utc); dayjs.extend(window.dayjs_plugin_timezone); dayjs.extend(window.dayjs_plugin_relativeTime); } 
            catch (e) { console.error("Lib Error", e); }

            const CONFIG = { url: 'https://olmaoftlbrookqwxvlvx.supabase.co', key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sbWFvZnRsYnJvb2txd3h2bHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTI0MzQsImV4cCI6MjA4NTgyODQzNH0.D7iwaB1rQbQwNvQAlFkYsxW7G12zIQAHSlksFr3KxZo' };
            const supabaseClient = supabase.createClient(CONFIG.url, CONFIG.key);
            let currentUser = null, currentSession = null, profilesMap = {}, userTimezone = dayjs.tz.guess(), isAdmin = false, isVerified = false;
            let APP_SETTINGS = { guild_id: "1465694444484427903", webhook: "", auto_approve: false };

            // --- LOAD SETTINGS ---
            async function loadSettings() {
                const { data } = await supabaseClient.from('app_config').select('*');
                if (data) {
                    data.forEach(row => {
                        if(row.key === 'required_guild_id') APP_SETTINGS.guild_id = row.value;
                        if(row.key === 'discord_webhook_url') APP_SETTINGS.webhook = row.value;
                        if(row.key === 'auto_approve') APP_SETTINGS.auto_approve = (row.value === 'true');
                    });
                }
            }

            // --- NAV ---
            function navTo(pageId) {
                ['login','onboarding','dashboard','roster','board','locked','admin'].forEach(p => { const el = document.getElementById(p+'-section'); if(el) el.classList.add('hidden'); });
                if(pageId === 'onboarding') { document.getElementById('onboarding-section').classList.remove('hidden'); document.getElementById('main-nav').style.display = 'none'; return; }
                if(!isVerified && pageId !== 'login' && pageId !== 'locked') { document.getElementById('locked-section').classList.remove('hidden'); document.getElementById('main-nav').style.display = 'none'; return; }
                document.getElementById('main-nav').style.display = 'flex';
                const t = document.getElementById(pageId+'-section'); if(t) t.classList.remove('hidden');
                if(pageId === 'roster') loadRoster();
                if(pageId === 'board') loadBoard();
                if(pageId === 'admin') loadAdminTable();
            }

            // --- HANDLERS ---
            function attach(id, evt, fn) { const el = document.getElementById(id); if(el) el.addEventListener(evt, fn); }
            attach('nav-home', 'click', () => navTo('dashboard'));
            attach('nav-roster', 'click', () => navTo('roster'));
            attach('nav-board', 'click', () => navTo('board'));
            attach('nav-admin', 'click', () => navTo('admin'));
            attach('loginBtn', 'click', async () => { await supabaseClient.auth.signInWithOAuth({ provider: 'discord', options: { redirectTo: window.location.origin + window.location.pathname, scopes: 'guilds' } }); });
            attach('retryScanBtn', 'click', async () => { await supabaseClient.auth.signInWithOAuth({ provider: 'discord', options: { redirectTo: window.location.origin + window.location.pathname, scopes: 'guilds' } }); });
            attach('logoutBtn', 'click', async () => { await supabaseClient.auth.signOut(); window.location.reload(); });
            attach('lockedLogoutBtn', 'click', async () => { await supabaseClient.auth.signOut(); window.location.reload(); });
            attach('resetAppBtn', 'click', () => { localStorage.clear(); window.location.reload(); });
            attach('roster-search', 'input', loadRoster);
            attach('roster-filter-region', 'change', loadRoster);
            attach('roster-filter-style', 'change', loadRoster);
            attach('roster-show-pending', 'change', loadRoster);
            attach('refreshAdminBtn', 'click', () => loadAdminTable());
            attach('openScheduleBtn', 'click', () => document.getElementById('scheduleModal').classList.remove('hidden'));
            attach('openEventModalBtn', 'click', () => document.getElementById('eventModal').classList.remove('hidden'));
            attach('saveConfigBtn', 'click', saveConfig);
            attach('openProfileModalBtn', 'click', () => {
                document.getElementById('ep-style').value = document.getElementById('u-playstyle').textContent;
                document.getElementById('ep-region').value = document.getElementById('u-region').textContent;
                document.getElementById('ep-timezone').value = document.getElementById('u-timezone').textContent;
                if(currentUserProfile) document.getElementById('ep-embark-id').value = currentUserProfile.embark_id || '';
                document.getElementById('profileModal').classList.remove('hidden');
            });
            if(document.getElementById('repairProfileBtn')) attach('repairProfileBtn', 'click', () => navTo('onboarding'));
            document.querySelectorAll('.close-modal').forEach(b => b.onclick = () => { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); });

            let currentUserProfile = null;

            // --- AUTH ---
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) { 
                currentSession = session; currentUser = session.user;
                await loadSettings(); 
                if(session.provider_token) await performGuildCheck(); 
                await checkProfile(); 
            } else { 
                supabaseClient.auth.onAuthStateChange(async (e, session) => { 
                    if(session) { 
                        currentSession = session; currentUser = session.user;
                        await loadSettings(); 
                        if(session.provider_token) await performGuildCheck(); 
                        await checkProfile(); 
                    } 
                }); 
            }

            async function performGuildCheck() {
                if(!currentSession?.provider_token) return;
                try {
                    const r = await fetch('https://discord.com/api/users/@me/guilds', { headers: { Authorization: `Bearer ${currentSession.provider_token}` } });
                    if(!r.ok) return;
                    const g = await r.json();
                    const isMember = g.some(x => x.id === APP_SETTINGS.guild_id);
                    if(isMember) {
                        const statusUpdate = APP_SETTINGS.auto_approve ? 'verified' : undefined; 
                        if(statusUpdate) await supabaseClient.from('profiles').update({ status: 'verified' }).eq('id', currentUser.id);
                        isVerified = true; checkProfile();
                    } else {
                        document.getElementById('locked-reason').textContent = "NOT A MEMBER OF TARGET SERVER.";
                        navTo('locked');
                    }
                } catch(e) { console.error(e); }
            }

            async function checkProfile() {
                const { data } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
                if (data) {
                    currentUserProfile = data; 
                    if (!data.discord_name) { navTo('onboarding'); return; }
                    isAdmin = data.is_admin || false;
                    isVerified = (data.status === 'verified') || isAdmin;

                    document.getElementById('u-name').textContent = data.discord_name;
                    document.getElementById('u-embark-display').textContent = data.embark_id ? `ID: ${data.embark_id}` : '';
                    document.getElementById('u-avatar').src = data.avatar_url || 'https://placehold.co/50';
                    document.getElementById('u-playstyle').textContent = data.play_style;
                    document.getElementById('u-region').textContent = data.region;
                    document.getElementById('u-timezone').textContent = data.timezone || userTimezone;
                    
                    if(isAdmin) {
                        document.getElementById('admin-badge').style.display = 'inline-block';
                        document.getElementById('pending-toggle-label').style.display = 'flex';
                        document.getElementById('nav-admin-li').style.display = 'block'; 
                        document.getElementById('cfg-guild-id').value = APP_SETTINGS.guild_id;
                        document.getElementById('cfg-webhook').value = APP_SETTINGS.webhook;
                        document.getElementById('cfg-auto-approve').checked = APP_SETTINGS.auto_approve;
                    }
                    
                    userTimezone = data.timezone || dayjs.tz.guess();
                    if(data.availability_json) populateScheduleModal(data.availability_json); else populateScheduleModal(null);

                    if (!isVerified) navTo('locked');
                    else { 
                        const {data: allP} = await supabaseClient.from('profiles').select('id, discord_name, embark_id');
                        if(allP) allP.forEach(p => profilesMap[p.id] = p.discord_name);
                        navTo('dashboard'); 
                    }
                } else { navTo('onboarding'); }
            }

            // --- CONFIG SAVE ---
            async function saveConfig() {
                if(!isAdmin) return;
                const updates = [
                    { key: 'required_guild_id', value: document.getElementById('cfg-guild-id').value },
                    { key: 'discord_webhook_url', value: document.getElementById('cfg-webhook').value },
                    { key: 'auto_approve', value: document.getElementById('cfg-auto-approve').checked ? 'true' : 'false' }
                ];
                for (const u of updates) await supabaseClient.from('app_config').upsert(u);
                alert("Settings Saved. Reloading..."); window.location.reload();
            }

            async function sendWebhook(title, desc, time) {
                if(!APP_SETTINGS.webhook) return;
                const payload = {
                    content: "üö® **NEW MISSION ALERT**",
                    embeds: [{ title: title, description: desc, color: 16733440, fields: [{ name: "Time", value: time, inline: true }, { name: "Link", value: window.location.href, inline: true }], footer: { text: "Raider // Signal" } }]
                };
                fetch(APP_SETTINGS.webhook, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            }

            // --- FORMS ---
            document.getElementById('profileForm').onsubmit = async (e) => {
                e.preventDefault();
                const payload = {
                    discord_name: currentUser.user_metadata.full_name || "Raider",
                    avatar_url: currentUser.user_metadata.avatar_url,
                    embark_id: document.getElementById('p-embark-id').value,
                    play_style: document.getElementById('p-style').value, 
                    region: document.getElementById('p-region').value, 
                    timezone: document.getElementById('p-timezone').value,
                };
                const { error } = await supabaseClient.from('profiles').upsert({ id: currentUser.id, ...payload, status: 'pending' });
                if(!error) checkProfile(); else alert(error.message);
            };

            document.getElementById('editProfileForm').onsubmit = async (e) => {
                e.preventDefault();
                const { error } = await supabaseClient.from('profiles').update({
                    embark_id: document.getElementById('ep-embark-id').value,
                    play_style: document.getElementById('ep-style').value, 
                    region: document.getElementById('ep-region').value, 
                    timezone: document.getElementById('ep-timezone').value
                }).eq('id', currentUser.id);
                if(!error) { document.getElementById('profileModal').classList.add('hidden'); checkProfile(); }
            };

            // --- ROSTER ---
            async function loadRoster() {
                if(!isVerified) return;
                const grid = document.getElementById('rosterGrid'); grid.innerHTML = 'Updating...';
                const { data: profiles } = await supabaseClient.from('profiles').select('*').order('created_at', {ascending: false});
                if(!profiles) { grid.innerHTML = 'Error.'; return; }
                grid.innerHTML = '';
                
                const search = document.getElementById('roster-search').value.toLowerCase();
                const reg = document.getElementById('roster-filter-region').value;
                const sty = document.getElementById('roster-filter-style').value;
                const showPending = document.getElementById('roster-show-pending').checked;
                const today = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][new Date().getDay()];

                profiles.forEach(p => {
                    const isPending = p.status === 'pending';
                    if (showPending && !isPending) return; 
                    if (!showPending && isPending) return; 
                    const matchName = p.discord_name && p.discord_name.toLowerCase().includes(search);
                    const matchID = p.embark_id && p.embark_id.toLowerCase().includes(search);
                    if (search && !matchName && !matchID) return;
                    if (reg !== 'ALL' && p.region !== reg) return;
                    if (sty !== 'ALL' && p.play_style !== sty) return;

                    let status = '<span style="color:var(--text-dim)">OFFLINE</span>';
                    if(isPending) status = '<span style="color:var(--locked-color)">[PENDING]</span>';
                    else if(p.availability_json && p.availability_json[today]?.active) {
                        const times = (p.availability_json[today].slots||[]).map(s=>`${s.start}-${s.end}`).join(' / ');
                        status = `<span style="color:var(--success-color)">ACTIVE: ${times}</span>`;
                    }

                    let actions = '';
                    if(isAdmin && p.id !== currentUser.id) {
                        if(isPending) actions += `<button class="mini-btn btn-green" onclick="window.approve('${p.id}')">APPROVE</button>`;
                        actions += `<button class="mini-btn btn-red" onclick="window.kick('${p.id}')">KICK</button>`;
                    }

                    grid.innerHTML += `
                        <div class="member-card">
                            <div class="member-header">
                                <img src="${p.avatar_url || 'https://placehold.co/50'}" class="member-avatar">
                                <div>
                                    <h3>${p.discord_name}</h3>
                                    <div style="font-size:0.9rem; color:var(--accent-color); font-weight:bold;">${p.embark_id || ''}</div>
                                    <div style="font-size:0.9rem; color:var(--text-dim)">${p.play_style} :: ${p.region}</div>
                                </div>
                            </div>
                            <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">${status}</div>
                            <div style="margin-top:10px;">${actions}</div>
                        </div>`;
                });
            }

            // --- ADMIN TABLE ---
            window.loadAdminTable = async () => {
                if(!isAdmin) return;
                const tb = document.getElementById('adminTableBody'); tb.innerHTML = 'Loading...';
                const { data: profiles } = await supabaseClient.from('profiles').select('*').order('created_at', {ascending: false});
                if(!profiles) return; tb.innerHTML = '';
                profiles.forEach(p => {
                    const isPending = p.status === 'pending';
                    const stat = isPending ? '<span class="status-pending">PENDING</span>' : '<span class="status-verified">VERIFIED</span>';
                    let act = '';
                    if(p.id !== currentUser.id) {
                        if(isPending) act += `<button class="mini-btn btn-green" onclick="window.approve('${p.id}')">OK</button>`;
                        act += `<button class="mini-btn btn-red" onclick="window.kick('${p.id}')">X</button>`;
                    }
                    tb.innerHTML += `<tr>
                        <td>${p.discord_name}</td>
                        <td>${p.embark_id || '-'}</td>
                        <td>${p.region}/${p.play_style}</td>
                        <td>${stat}</td>
                        <td>${dayjs(p.created_at).format('MMM D')}</td>
                        <td>${act}</td>
                    </tr>`;
                });
            };

            // --- GLOBAL ACTIONS ---
            window.approve = async (id) => { if(confirm('Approve?')) { await supabaseClient.from('profiles').update({status:'verified'}).eq('id', id); loadRoster(); loadAdminTable(); }};
            window.kick = async (id) => { if(confirm('Kick?')) { await supabaseClient.from('profiles').delete().eq('id', id); loadRoster(); loadAdminTable(); }};
            
            // --- BOARD ---
            async function loadBoard() {
                if(!isVerified) return;
                const grid = document.getElementById('eventsGrid'); grid.innerHTML = 'Scanning...';
                const { data: events } = await supabaseClient.from('events').select('*').order('start_time', {ascending: true});
                const { data: signups } = await supabaseClient.from('event_signups').select('*');
                if(!events) { grid.innerHTML = 'No Ops.'; return; }
                grid.innerHTML = '';
                
                events.forEach(ev => {
                    const attending = signups?.filter(s => s.event_id === ev.id) || [];
                    const isSignedUp = attending.some(s => s.user_id === currentUser.id);
                    const isHost = ev.host_id === currentUser.id;
                    
                    grid.innerHTML += `<div class="event-card">
                        ${(isHost||isAdmin) ? `<button class="btn-admin-delete" onclick="window.delEvent('${ev.id}')">DEL</button>` : ''}
                        <div class="event-title">${ev.title}</div>
                        <div class="mission-type">${ev.mission_type}</div>
                        <div style="margin:10px 0; font-weight:bold; font-size:1.2rem; color:var(--text-main)">${dayjs(ev.start_time).tz(userTimezone).format('MMM D, HH:mm')}</div>
                        <div style="color:var(--text-dim)">${ev.description}</div>
                        <div class="attendees-list">SQUAD [${attending.length}]: ${attending.map(s => `<span class="attendee-pill">${profilesMap[s.user_id]||'Agent'}</span>`).join('')}</div>
                        ${isSignedUp ? `<button class="btn-leave" onclick="window.leaveEvent('${ev.id}')">ABORT</button>` : `<button class="btn-join" onclick="window.joinEvent('${ev.id}')">JOIN</button>`}
                    </div>`;
                });
            }

            window.joinEvent = async (id) => { await supabaseClient.from('event_signups').insert({event_id: id, user_id: currentUser.id}); loadBoard(); };
            window.leaveEvent = async (id) => { await supabaseClient.from('event_signups').delete().match({event_id: id, user_id: currentUser.id}); loadBoard(); };
            window.delEvent = async (id) => { if(confirm('Delete?')) { await supabaseClient.from('events').delete().eq('id', id); loadBoard(); } };

            document.getElementById('eventForm').onsubmit = async (e) => {
                e.preventDefault();
                const utc = dayjs.tz(document.getElementById('e-time').value, document.getElementById('e-timezone').value).utc().format();
                const conds = []; document.querySelectorAll('input[name="cond"]:checked').forEach(c=>conds.push(c.value));
                await supabaseClient.from('events').insert({
                    title: document.getElementById('e-title').value,
                    description: document.getElementById('e-desc').value,
                    start_time: utc,
                    timezone: document.getElementById('e-timezone').value,
                    region: document.getElementById('e-region').value,
                    mission_type: document.getElementById('e-type').value,
                    conditions: conds,
                    host_id: currentUser.id
                });
                const friendlyTime = dayjs(utc).format('YYYY-MM-DD HH:mm [UTC]');
                sendWebhook(document.getElementById('e-title').value, document.getElementById('e-desc').value, friendlyTime);
                document.getElementById('eventModal').classList.add('hidden'); loadBoard();
            };

            // --- HELPERS ---
            function populateTimezones(id) { const s = document.getElementById(id); if(!s) return; Intl.supportedValuesOf('timeZone').forEach(t=>{const o=document.createElement('option');o.value=t;o.text=t;if(t===userTimezone)o.selected=true;s.appendChild(o);}); }
            populateTimezones('p-timezone'); populateTimezones('ep-timezone'); populateTimezones('e-timezone');
            
            function populateScheduleModal(json) {
                const con = document.getElementById('daysContainer'); con.innerHTML = '';
                ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(d => {
                    const active = json?.[d]?.active;
                    const div = document.createElement('div'); div.className = `day-section ${active?'':'disabled-day'}`;
                    div.innerHTML = `<div class="day-header"><label><input type="checkbox" class="d-check" data-day="${d}" ${active?'checked':''}> <strong>${d.toUpperCase()}</strong></label> <button type="button" class="add-slot-btn">+</button></div><div class="slots-container"></div>`;
                    const slotCon = div.querySelector('.slots-container');
                    (json?.[d]?.slots || []).forEach(s => addSlotUI(slotCon, s.start, s.end));
                    div.querySelector('.add-slot-btn').onclick = () => addSlotUI(slotCon);
                    div.querySelector('.d-check').onchange = (e) => div.classList.toggle('disabled-day', !e.target.checked);
                    con.appendChild(div);
                });
            }
            function addSlotUI(con, s='18:00', e='22:00') {
                const d = document.createElement('div'); d.className='time-slot';
                d.innerHTML = `<input type="time" class="t-start" value="${s}"> to <input type="time" class="t-end" value="${e}"> <button type="button" onclick="this.parentElement.remove()">X</button>`;
                con.appendChild(d);
            }
            document.getElementById('scheduleForm').onsubmit = async (e) => {
                e.preventDefault();
                const res = {};
                document.querySelectorAll('.d-check').forEach(c => {
                    const day = c.dataset.day;
                    const slots = [];
                    if(c.checked) c.closest('.day-section').querySelectorAll('.time-slot').forEach(s => slots.push({start:s.querySelector('.t-start').value, end:s.querySelector('.t-end').value}));
                    res[day] = {active: c.checked, slots};
                });
                await supabaseClient.from('profiles').update({availability_json: res}).eq('id', currentUser.id);
                document.getElementById('scheduleModal').classList.add('hidden'); checkProfile();
            };
        });
    </script>
</body>
</html>
